<!doctype html>
<meta charset="utf-8">
<title>kbcy Daily Announcement</title>
<style>
  body{font:14px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; margin:24px}
  h1{font-size:20px; margin:0 0 12px}
  .muted{color:#666; font-size:12px}
  button{padding:8px 14px; border:1px solid #e5e7eb; border-radius:10px; background:#f8f9fb; cursor:pointer}
  textarea{width:100%; height:260px; margin-top:8px; font-family:ui-monospace,Consolas,Menlo,monospace}
</style>

<!-- タイトル -->
<h1>kbcy Daily Announcement</h1>

<!-- 注釈文 -->
<div class="muted">［議事堂戦・戦域戦や隕鉄などの突発イベントは手入力ください］</div>

<!-- コピーボタン -->
<p><button id="copyBtn">この内容をコピー</button> <span id="msg" class="muted"></span></p>

<!-- テキストエリア -->
<textarea id="raw" placeholder="読込中…"></textarea>
<div class="muted">必要ならここで編集してからコピーしてもOK。</div>

<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwf-CnItLOCeiucXiq6IF2ohA3wGEZjEuj1WL6mSwSORunJNdydtCK17reJw81wJISQwg/exec?api=fetch';

  const raw = document.getElementById('raw');
  const msg = document.getElementById('msg');

  function applyData(payload){
    const ok = payload?.ok ?? true;
    const data = ok ? (payload.data ?? payload) : null;
    if (!ok) throw new Error(payload.error || 'Unknown GAS error');

    raw.value = data.text || '';
    msg.textContent = '読み込み完了';
  }

  function showError(e){
    const m = (e && (e.message || e)) || 'Unknown error';
    raw.value = '';
    msg.textContent = 'エラー: ' + m;
    console.error('[load error]', e);
  }

  async function load(){
    try{
      msg.textContent = '読込中…';
      const r = await fetch(ENDPOINT);
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const json = await r.json();
      applyData(json);
      return;
    }catch(e){
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      window[cb] = (json)=>{ try{ applyData(json); }catch(e){ showError(e); } finally{ delete window[cb]; } };
      const s = document.createElement('script');
      s.src = ENDPOINT + '&alt=jsonp&callback=' + cb;
      s.onerror = ()=> showError('JSONP load error');
      document.body.appendChild(s);
    }
  }

  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(raw.value); msg.textContent = 'コピーしました'; }
    catch{ raw.focus(); raw.select(); msg.textContent = document.execCommand('copy') ? 'コピーしました（fallback）' : 'コピー失敗…'; }
  });

  window.addEventListener('load', load);
</script>
