<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>今週の列車担当</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-top: 12px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background: #f7f7f7; }
    button { padding: 8px 14px; border: 0; border-radius: 8px; background: #111; color: #fff; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    select { padding: 6px 8px; border-radius: 6px; }
    .muted { color: #666; font-size: 0.9em; margin-left: 8px; }
    .actions { display: flex; gap: 8px; margin-top: 12px; align-items: center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h2>今週の列車担当</h2>

  <form id="rankForm">
    <table>
      <thead><tr><th>曜日</th><th>ランク条件</th><th>個人指定</th></tr></thead>
      <tbody>
        <!-- 月曜 -->
        <tr>
          <td>月曜</td>
          <td>
            <select name="mon" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54" selected>R5,4</option>
              <option value="r3">R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="mon_person" class="personSelect" style="display:none"></select></td>
        </tr>

        <!-- 火曜 -->
        <tr>
          <td>火曜</td>
          <td>
            <select name="tue" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="tue_person" class="personSelect" style="display:none"></select></td>
        </tr>

        <!-- 水曜 -->
        <tr>
          <td>水曜</td>
          <td>
            <select name="wed" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="wed_person" class="personSelect" style="display:none"></select></td>
        </tr>

        <!-- 木曜 -->
        <tr>
          <td>木曜</td>
          <td>
            <select name="thu" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="thu_person" class="personSelect" style="display:none"></select></td>
        </tr>

        <!-- 金曜 -->
        <tr>
          <td>金曜</td>
          <td>
            <select name="fri" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="fri_person" class="personSelect" style="display:none"></select></td>
        </tr>

        <!-- 土曜 -->
        <tr>
          <td>土曜</td>
          <td>
            <select name="sat" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="sat_person" class="personSelect" style="display:none"></select></td>
        </tr>

        <!-- 日曜 -->
        <tr>
          <td>日曜</td>
          <td>
            <select name="sun" onchange="togglePersonSelect(this)">
              <option value="none" selected>なし</option>
              <option value="r54">R5,4</option>
              <option value="r3">R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="sun_person" class="personSelect" style="display:none"></select></td>
        </tr>
      </tbody>
    </table>

    <div class="actions">
      <button type="button" id="btnPreview">プレビュー</button>
      <button type="button" id="btnConfirm" disabled>確定</button>
      <span id="status" class="muted">条件を選んで「プレビュー」してください</span>
    </div>
  </form>

  <table id="result" style="display:none">
    <thead><tr><th>曜日</th><th>日付（翌週）</th><th>担当</th></tr></thead>
    <tbody id="tbody-result"></tbody>
  </table>

  <script>
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwf-CnItLOCeiucXiq6IF2ohA3wGEZjEuj1WL6mSwSORunJNdydtCK17reJw81wJISQwg/exec";
    const API_TOKEN    = "absdo24365";

    let memberList = [];
    let lastPreview = null;

    window.addEventListener("DOMContentLoaded", async () => {
      // メンバー一覧（個人指定用）
      try {
        const url = `${GAS_ENDPOINT}?action=getMembers&token=${API_TOKEN}`;
        const resp = await fetch(url, { cache: "no-store" });
        const data = await resp.json();
        if (data.ok && data.members) {
          memberList = data.members;
          document.querySelectorAll(".personSelect").forEach(sel => {
            sel.innerHTML = '<option value="">選択してください</option>';
            memberList.forEach(name => sel.innerHTML += `<option value="${name}">${name}</option>`);
          });
        }
      } catch (e) { console.error("メンバー取得失敗", e); }

      document.getElementById("btnPreview").addEventListener("click", preview);
      document.getElementById("btnConfirm").addEventListener("click", confirmAssign);
    });

    function togglePersonSelect(selectEl) {
      const personSelect = selectEl.parentElement.nextElementSibling.querySelector("select");
      if (selectEl.value === "person") {
        personSelect.style.display = "inline";
      } else {
        personSelect.style.display = "none";
        personSelect.value = "";
      }
    }

    async function preview() {
      setBusy(true, "抽選中...");
      const form = document.getElementById("rankForm");
      const params = new URLSearchParams(new FormData(form));
      params.append("action", "previewWeekAssignments");
      params.append("token", API_TOKEN);

      document.querySelectorAll(".personSelect").forEach(sel => {
        if (sel.style.display !== "none" && sel.value) params.append(sel.name, sel.value);
      });

      try {
        const url = `${GAS_ENDPOINT}?${params.toString()}`;
        const resp = await fetch(url, { method: "GET", cache: "no-store" });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || "unknown error");

        lastPreview = { week: data.week || [], ranksToReset: data.ranksToReset || [] };
        renderResult(lastPreview.week);

        setBusy(false, "プレビュー完了。内容を確認して「確定」へ。");
        document.getElementById("btnConfirm").disabled = false;
      } catch (err) {
        console.error(err);
        setBusy(false, "エラー: " + err.message);
      }
    }

    async function confirmAssign() {
  if (!lastPreview) { setBusy(false, "先にプレビューしてください"); return; }
  setBusy(true, "確定中...");

  try {
    const resp = await fetch(GAS_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },   // ← 修正
      body: JSON.stringify({
        action: "confirmWeekAssignments",
        token: API_TOKEN,
        week: lastPreview.week
      })
    });

    const data = await resp.json();   // ← JSON 前提
    if (!data.ok) throw new Error(data.error || "unknown error");

    setBusy(false, "確定しました！（スプレッドに反映済み）");
    document.getElementById("btnPreview").disabled = true;
    document.getElementById("btnConfirm").disabled = true;
    document.getElementById("status").textContent = "確定済み。再抽選はできません。";
  } catch (err) {
    console.error(err);
    setBusy(false, "エラー: " + err.message);
  }
}
    function renderResult(week) {
      const tbody = document.getElementById("tbody-result");
      tbody.innerHTML = "";
      week.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.weekday}</td><td>${row.date}</td><td>${row.assignee || "-"}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById("result").style.display = "";
    }

    function setBusy(isBusy, msg) {
      document.getElementById("btnPreview").disabled = isBusy || document.getElementById("btnPreview").disabled;
      document.getElementById("btnConfirm").disabled = isBusy || !lastPreview;
      document.getElementById("status").textContent = msg;
    }
  </script>
</body>
</html>
