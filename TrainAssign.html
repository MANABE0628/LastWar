<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>今週の列車担当（プレビュー→確定）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-top: 12px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background: #f7f7f7; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 14px; border: 0; border-radius: 8px; background: #111; color: #fff; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    select { padding: 6px 8px; border-radius: 6px; }
    .muted { color: #666; font-size: 0.9em; }
    .actions { display: flex; gap: 8px; margin-top: 12px; }
  </style>
</head>
<body>
  <h2>今週の列車担当（プレビュー→確定）</h2>

  <form id="rankForm">
    <table>
      <thead><tr><th>曜日</th><th>ランク条件</th><th>個人指定</th></tr></thead>
      <tbody>
        <tr>
          <td>月曜</td>
          <td>
            <select name="mon" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54" selected>R5,4</option>
              <option value="r3">R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="mon_person" class="personSelect" style="display:none"></select></td>
        </tr>
        <tr>
          <td>火曜</td>
          <td>
            <select name="tue" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="tue_person" class="personSelect" style="display:none"></select></td>
        </tr>
        <tr>
          <td>水曜</td>
          <td>
            <select name="wed" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="wed_person" class="personSelect" style="display:none"></select></td>
        </tr>
        <tr>
          <td>木曜</td>
          <td>
            <select name="thu" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="thu_person" class="personSelect" style="display:none"></select></td>
        </tr>
        <tr>
          <td>金曜</td>
          <td>
            <select name="fri" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="fri_person" class="personSelect" style="display:none"></select></td>
        </tr>
        <tr>
          <td>土曜</td>
          <td>
            <select name="sat" onchange="togglePersonSelect(this)">
              <option value="none">なし</option>
              <option value="r54">R5,4</option>
              <option value="r3" selected>R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="sat_person" class="personSelect" style="display:none"></select></td>
        </tr>
        <tr>
          <td>日曜</td>
          <td>
            <select name="sun" onchange="togglePersonSelect(this)">
              <option value="none" selected>なし</option>
              <option value="r54">R5,4</option>
              <option value="r3">R3</option>
              <option value="both">R5,4+R3</option>
              <option value="person">個人指定</option>
            </select>
          </td>
          <td><select name="sun_person" class="personSelect" style="display:none"></select></td>
        </tr>
      </tbody>
    </table>

    <div class="actions">
      <button type="button" id="btnPreview">プレビュー</button>
      <button type="button" id="btnRedo" disabled>再抽選</button>
      <button type="button" id="btnConfirm" disabled>確定</button>
      <span id="status" class="muted">各曜日の条件を選んでプレビュー</span>
    </div>
  </form>

  <table id="result" style="display:none">
    <thead><tr><th>曜日</th><th>日付</th><th>担当</th></tr></thead>
    <tbody id="tbody-result"></tbody>
  </table>

  <script>
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwAuBBWw3EmgkMvY1lPTv70XIV07UWIKqV-y8VX80vZEk5P1LoQi0M6wvJzJRDW_yPp/exec";
    const API_TOKEN    = "absdo24365";

    let memberList = [];
    let lastPreview = null; // { week: [...], ranksToReset: [...] }

    window.addEventListener("DOMContentLoaded", async () => {
      // メンバー一覧取得（個人指定用）
      try {
        const url = `${GAS_ENDPOINT}?action=getMembers&token=${API_TOKEN}`;
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.ok && data.members) {
          memberList = data.members;
          document.querySelectorAll(".personSelect").forEach(sel => {
            sel.innerHTML = '<option value="">選択してください</option>';
            memberList.forEach(name => sel.innerHTML += `<option value="${name}">${name}</option>`);
          });
        }
      } catch (e) { console.error("メンバー取得失敗", e); }

      // ボタンイベント
      document.getElementById("btnPreview").addEventListener("click", preview);
      document.getElementById("btnRedo").addEventListener("click", preview);
      document.getElementById("btnConfirm").addEventListener("click", confirmAssign);
    });

    function togglePersonSelect(selectEl) {
      const personSelect = selectEl.parentElement.nextElementSibling.querySelector("select");
      if (selectEl.value === "person") {
        personSelect.style.display = "inline";
      } else {
        personSelect.style.display = "none";
        personSelect.value = "";
      }
    }

    async function preview() {
      setBusy(true, "抽選中...");
      const form = document.getElementById("rankForm");
      const params = new URLSearchParams(new FormData(form));
      params.append("action", "previewWeekAssignments");
      params.append("token", API_TOKEN);

      // person 選択時のみ *_person を含める（空は送らない）
      document.querySelectorAll(".personSelect").forEach(sel => {
        const rankSel = sel.closest("tr").querySelector("select[name$='']") || null;
        if (sel.style.display !== "none" && sel.value) {
          params.append(sel.name, sel.value);
        }
      });

      try {
        const url = `${GAS_ENDPOINT}?${params.toString()}`;
        const resp = await fetch(url, { method: "GET", cache: "no-store" });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || "unknown error");
        lastPreview = { week: data.week || [], ranksToReset: data.ranksToReset || [] };
        renderResult(lastPreview.week);
        setBusy(false, "プレビュー完了。内容を確認して「確定」へ。");
        document.getElementById("btnConfirm").disabled = false;
        document.getElementById("btnRedo").disabled = false;
      } catch (err) {
        console.error(err);
        setBusy(false, "エラー: " + err.message);
      }
    }

    async function confirmAssign() {
      if (!lastPreview) {
        setBusy(false, "先にプレビューしてください");
        return;
      }
      setBusy(true, "確定中...");
      try {
        const url = `${GAS_ENDPOINT}?action=confirmWeekAssignments&token=${API_TOKEN}`;
        const body = JSON.stringify(lastPreview); // {week, ranksToReset}
        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body
        });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || "unknown error");
        setBusy(false, "確定しました！（スプレッドに反映済み）");
        // 確定後は再度プレビュー/確定できるように維持
      } catch (err) {
        console.error(err);
        setBusy(false, "エラー: " + err.message);
      }
    }

    function renderResult(week) {
      const tbody = document.getElementById("tbody-result");
      tbody.innerHTML = "";
      week.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.weekday}</td><td>${row.date}</td><td>${row.assignee || "-"}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById("result").style.display = "";
    }

    function setBusy(isBusy, msg) {
      document.getElementById("btnPreview").disabled = isBusy;
      document.getElementById("btnRedo").disabled = isBusy;
      document.getElementById("btnConfirm").disabled = isBusy || !lastPreview;
      document.getElementById("status").textContent = msg;
    }
  </script>
</body>
</html>